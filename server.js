// server.js
// ------------------------------
// AI Prompt Web â€” Veo 3.1 Helper
// ------------------------------
// - à¹ƒà¸Šà¹‰ Express + CORS + bodyParser
// - à¹€à¸ªà¸´à¸£à¹Œà¸Ÿ index.html, css, js à¸ˆà¸²à¸à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸šà¹„à¸Ÿà¸¥à¹Œà¸™à¸µà¹‰
// - à¸¡à¸µ API à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸£à¹‰à¸²à¸‡ Prompt à¹‚à¸«à¸¡à¸” Veo 3.1 à¸—à¸µà¹ˆ path: POST /api/veo-flow
// - à¸£à¸±à¸™à¹„à¸”à¹‰à¸—à¸±à¹‰à¸‡à¸šà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ (localhost:3001) à¹à¸¥à¸°à¸šà¸™à¹‚à¸®à¸ªà¸•à¹Œ (à¹ƒà¸Šà¹‰ process.env.PORT)
// ------------------------------

import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import OpenAI from "openai";
import dotenv from "dotenv";
import path from "path";
import { fileURLToPath } from "url";

// à¹‚à¸«à¸¥à¸”à¸•à¸±à¸§à¹à¸›à¸£à¸ˆà¸²à¸ .env (à¹ƒà¸Šà¹‰à¸•à¸­à¸™à¸£à¸±à¸™à¸šà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸•à¸±à¸§à¹€à¸­à¸‡)
// à¸šà¸™ Deno / à¹‚à¸®à¸ªà¸•à¹Œà¸­à¸·à¹ˆà¸™à¸ˆà¸°à¹ƒà¸Šà¹‰ Environment Variables à¹à¸—à¸™
dotenv.config();

// à¸ªà¸£à¹‰à¸²à¸‡à¹à¸­à¸› Express
const app = express();

// âœ… à¸žà¸­à¸£à¹Œà¸•: à¸–à¹‰à¸²à¸¡à¸µ PORT à¸ˆà¸²à¸à¹‚à¸®à¸ªà¸•à¹Œà¹ƒà¸Šà¹‰à¸•à¸²à¸¡à¸™à¸±à¹‰à¸™, à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸à¹‡à¹ƒà¸Šà¹‰ 3001 (à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡)
const port = process.env.PORT || 3001;

// à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² OpenAI Client
// à¸•à¹‰à¸­à¸‡à¸¡à¸µ OPENAI_API_KEY à¸—à¸±à¹‰à¸‡à¸•à¸­à¸™à¸£à¸±à¸™à¹ƒà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ (.env) à¹à¸¥à¸°à¸•à¸­à¸™à¸£à¸±à¸™à¸šà¸™à¹‚à¸®à¸ªà¸•à¹Œ (env à¸‚à¸­à¸‡à¹‚à¸®à¸ªà¸•à¹Œ)
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Middleware à¸žà¸·à¹‰à¸™à¸à¸²à¸™
app.use(cors());
app.use(
  bodyParser.json({
    limit: "15mb",
  })
);

// à¹€à¸ªà¸´à¸£à¹Œà¸Ÿà¹„à¸Ÿà¸¥à¹Œ static (index.html, main.js, css à¸¯à¸¥à¸¯) à¸ˆà¸²à¸à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œà¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸š server.js
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
app.use(express.static(__dirname));

// ------------------------------
// Helper: System Prompt à¸ªà¸³à¸«à¸£à¸±à¸š Veo 3.1
// ------------------------------
function buildSystemPromptVeo31() {
  return `
à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸ªà¸£à¹‰à¸²à¸‡ "Prompt à¸ªà¸³à¸«à¸£à¸±à¸š Google Veo 3.1" à¸—à¸µà¹ˆà¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸‡à¸²à¸™à¹‚à¸†à¸©à¸“à¸² à¹à¸¥à¸°à¸„à¸¥à¸´à¸›à¸ªà¸±à¹‰à¸™à¹à¸™à¸§ TikTok / Reels / Shorts

à¸à¸•à¸´à¸à¸²à¸ªà¸³à¸„à¸±à¸:
- à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ "à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ 100%" à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
- à¹€à¸‚à¸µà¸¢à¸™à¹ƒà¸«à¹‰à¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢ à¹‚à¸Ÿà¸à¸±à¸ªà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸ˆà¸£à¸´à¸‡
- à¹€à¸™à¹‰à¸™à¸ªà¹„à¸•à¸¥à¹Œ "à¸¡à¸·à¸­à¸­à¸²à¸Šà¸µà¸ž + à¸ªà¸¡à¸ˆà¸£à¸´à¸‡" à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸‡à¸²à¸™à¸‚à¸²à¸¢à¸ªà¸´à¸™à¸„à¹‰à¸² à¸—à¸³à¹‚à¸†à¸©à¸“à¸² à¹à¸¥à¸°à¸•à¸¥à¸²à¸”à¸™à¸±à¸”à¸šà¹‰à¸²à¸™ à¹†
- à¸—à¸³ Prompt à¸­à¸­à¸à¸¡à¸²à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸”à¸µà¸¢à¸§" (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸§à¹‰à¸™à¸«à¸±à¸§à¸‚à¹‰à¸­à¸¢à¹ˆà¸­à¸¢à¸«à¸¥à¸²à¸¢à¸šà¸£à¸£à¸—à¸±à¸”à¹€à¸à¸´à¸™à¸ˆà¸³à¹€à¸›à¹‡à¸™ à¹€à¸§à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸”à¹„à¸”à¹‰à¹à¸•à¹ˆà¸•à¹‰à¸­à¸‡à¸„à¸±à¸”à¸¥à¸­à¸à¹„à¸›à¹ƒà¸Šà¹‰à¸—à¸µà¹ˆ Veo 3.1 à¹„à¸”à¹‰à¸•à¸£à¸‡ à¹†)
- à¸–à¹‰à¸²à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸£à¸°à¸šà¸¸à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸žà¸´à¹€à¸¨à¸© à¹€à¸Šà¹ˆà¸™: à¸«à¹‰à¸²à¸¡à¸¡à¸µà¸•à¸±à¸§à¸«à¸™à¸±à¸‡à¸ªà¸·à¸­à¸šà¸™à¸«à¸™à¹‰à¸²à¸ˆà¸­, à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§ 8 à¸§à¸´à¸™à¸²à¸—à¸µ, 4K, à¹à¸™à¸§à¸•à¸±à¹‰à¸‡, à¸¯à¸¥à¸¯ à¹ƒà¸«à¹‰à¹ƒà¸ªà¹ˆà¸¥à¸‡à¹„à¸›à¸„à¸£à¸šà¸–à¹‰à¸§à¸™à¹ƒà¸™ Prompt à¹€à¸ªà¸¡à¸­

à¹‚à¸Ÿà¸à¸±à¸ªà¸‡à¸²à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“:
- à¹à¸›à¸¥à¸‡à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¹‰à¸à¸¥à¸²à¸¢à¹€à¸›à¹‡à¸™ "Prompt à¹€à¸”à¸µà¸¢à¸§à¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰" à¸ªà¸³à¸«à¸£à¸±à¸š Veo 3.1
- à¹ƒà¸ªà¹ˆà¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹ƒà¸«à¹‰à¸„à¸£à¸š: à¸‰à¸²à¸ / à¸™à¸±à¸à¹à¸ªà¸”à¸‡ / à¸¡à¸¸à¸¡à¸à¸¥à¹‰à¸­à¸‡ / à¹à¸ªà¸‡ / à¸­à¸²à¸£à¸¡à¸“à¹Œ / à¹‚à¸—à¸™à¸ à¸²à¸ž / à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§ / à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ / à¸šà¸£à¸£à¸¢à¸²à¸à¸²à¸¨
- à¸–à¹‰à¸²à¸¡à¸µà¸šà¸—à¸žà¸¹à¸” à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸¸à¹ƒà¸™ Prompt à¸”à¹‰à¸§à¸¢ à¸§à¹ˆà¸²à¸„à¸™à¹ƒà¸™à¸‰à¸²à¸à¸žà¸¹à¸”à¸§à¹ˆà¸²à¸­à¸°à¹„à¸£ (à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢)

à¸£à¸¹à¸›à¹à¸šà¸šà¸„à¸³à¸•à¸­à¸š:
- à¹ƒà¸«à¹‰à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ "Prompt à¹€à¸”à¸µà¸¢à¸§à¹€à¸•à¹‡à¸¡ à¹†" à¸žà¸£à¹‰à¸­à¸¡à¸„à¸±à¸”à¸¥à¸­à¸à¹„à¸›à¹ƒà¸Šà¹‰à¸—à¸µà¹ˆ Veo 3.1 à¹„à¸”à¹‰à¸—à¸±à¸™à¸—à¸µ
- à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆà¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸­à¸·à¹ˆà¸™à¹€à¸žà¸´à¹ˆà¸¡ à¹€à¸Šà¹ˆà¸™ à¸„à¸³à¸§à¹ˆà¸²à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢, à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸, à¸‚à¹‰à¸­ 1 2 3 à¸¯à¸¥à¸¯
- à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆ Markdown à¹€à¸Šà¹ˆà¸™ \`\`\`, **à¸•à¸±à¸§à¸«à¸™à¸²**, à¸«à¸±à¸§à¸‚à¹‰à¸­ # à¸­à¸°à¹„à¸£à¸—à¸±à¹‰à¸‡à¸™à¸±à¹‰à¸™

à¸ˆà¸³à¹„à¸§à¹‰à¸§à¹ˆà¸²à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ Prompt à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢" à¹€à¸žà¸µà¸¢à¸‡à¸à¹‰à¸­à¸™à¹€à¸”à¸µà¸¢à¸§à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
`;
}

// ------------------------------
// API à¸«à¸¥à¸±à¸: à¸ªà¸£à¹‰à¸²à¸‡ Prompt Veo 3.1
// ------------------------------
// Frontend à¹€à¸£à¸µà¸¢à¸: POST /api/veo-flow
// body à¸—à¸µà¹ˆà¸„à¸²à¸”à¸«à¸§à¸±à¸‡:
// {
//   "userPrompt": "à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸—à¸µà¹ˆà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸à¸£à¸­à¸ à¹€à¸Šà¹ˆà¸™ à¸ªà¸´à¸™à¸„à¹‰à¸²à¸­à¸°à¹„à¸£ à¸™à¸±à¸à¹à¸ªà¸”à¸‡à¸ªà¹„à¸•à¸¥à¹Œà¹„à¸«à¸™ à¸¯à¸¥à¸¯"
// }
// ------------------------------
app.post("/api/veo-flow", async (req, res) => {
  try {
    const { userPrompt } = req.body;

    if (!userPrompt || typeof userPrompt !== "string") {
      return res.status(400).json({
        ok: false,
        error: "à¸à¸£à¸¸à¸“à¸²à¸ªà¹ˆà¸‡à¸„à¹ˆà¸² userPrompt (string) à¸¡à¸²à¸”à¹‰à¸§à¸¢à¹ƒà¸™ body",
      });
    }

    const systemPrompt = buildSystemPromptVeo31();

    const completion = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      temperature: 0.9,
    });

    const content =
      completion.choices?.[0]?.message?.content?.trim() || "";

    return res.json({
      ok: true,
      prompt: content,
    });
  } catch (err) {
    console.error("âŒ Error in /api/veo-flow:", err);

    return res.status(500).json({
      ok: false,
      error: "Server error à¸ˆà¸²à¸à¸à¸±à¹ˆà¸‡ backend",
      detail: err?.message || String(err),
    });
  }
});

// ------------------------------
// Health Check (à¹€à¸­à¸²à¹„à¸§à¹‰à¹€à¸—à¸ªà¸•à¹Œà¸šà¸™à¹‚à¸®à¸ªà¸•à¹Œ / Deno)
// ------------------------------
app.get("/health", (req, res) => {
  return res.json({
    ok: true,
    status: "healthy",
    port,
  });
});

// ------------------------------
// à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸±à¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ
// ------------------------------
// à¹ƒà¸Šà¹‰ 0.0.0.0 à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰:
// - à¸£à¸±à¸™à¸šà¸™ Deno / à¹‚à¸®à¸ªà¸•à¹Œà¸­à¸·à¹ˆà¸™ à¹† à¹„à¸”à¹‰
// - à¸«à¸£à¸·à¸­à¹ƒà¸«à¹‰à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸­à¸·à¹ˆà¸™à¹ƒà¸™à¸§à¸‡ Wi-Fi access à¹„à¸”à¹‰ (à¸–à¹‰à¸²à¸£à¸±à¸™à¹ƒà¸™à¸šà¹‰à¸²à¸™)
app.listen(port, "0.0.0.0", () => {
  console.log(`ðŸš€ Server running on port ${port}`);
  console.log(`âž¡  http://localhost:${port}/`);
});
